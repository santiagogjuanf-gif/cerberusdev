<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" sizes="192x192" href="/assets/img/favicon.png">
  <title>Cerberus Control Room | Lead</title>
  <link rel="stylesheet" href="/assets/css/styles.css"/>
  <link rel="stylesheet" href="/assets/css/admin.css"/>
  <style>
    /* Futuristic Background */
    .admin-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,122,24,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,122,24,0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 40%, transparent 100%);
      -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 40%, transparent 100%);
      pointer-events: none;
    }
    .admin-bg::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,122,24,0.4), transparent);
      animation: scanline 8s linear infinite;
      opacity: 0.6;
      pointer-events: none;
    }
    @keyframes scanline {
      0% { top: 0; opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { top: 100%; opacity: 0; }
    }
    .dashboard-header {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-logo {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,122,24,0.2), rgba(255,122,24,0.05));
      border: 1px solid rgba(255,122,24,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(255,122,24,0.2), inset 0 0 20px rgba(255,122,24,0.1);
      animation: logoPulse 3s ease-in-out infinite;
      padding: 10px;
    }
    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(255,122,24,0.4));
    }
    @keyframes logoPulse {
      0%, 100% { box-shadow: 0 0 30px rgba(255,122,24,0.2), inset 0 0 20px rgba(255,122,24,0.1); }
      50% { box-shadow: 0 0 40px rgba(255,122,24,0.35), inset 0 0 25px rgba(255,122,24,0.15); }
    }
    .admin-title::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #FF7A18, transparent);
      border-radius: 2px;
    }
    .admin-title { position: relative; }
    .admin-sub {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-sub::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      animation: statusBlink 2s ease-in-out infinite;
      box-shadow: 0 0 8px #22c55e;
    }
    @keyframes statusBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    /* Corner accents for cards */
    .admin-card::before,
    .admin-card::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,122,24,0.3);
      pointer-events: none;
    }
    .admin-card::before {
      top: -1px;
      left: -1px;
      border-right: none;
      border-bottom: none;
      border-radius: 16px 0 0 0;
    }
    .admin-card::after {
      bottom: -1px;
      right: -1px;
      border-left: none;
      border-top: none;
      border-radius: 0 0 16px 0;
    }
    .lead-grid {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 16px;
    }
    .lead-field { margin-bottom: 16px; }
    .lead-label {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.08em; color: rgba(255,255,255,0.5);
      margin-bottom: 6px;
    }
    .lead-value {
      font-size: 15px; line-height: 1.7;
      color: rgba(255,255,255,0.88);
      white-space: pre-wrap;
    }
    .lead-value a {
      color: #FF9A45;
      text-decoration: none;
    }
    .lead-value a:hover { text-decoration: underline; }
    .lead-actions {
      display: flex; gap: 8px; flex-wrap: wrap;
      padding-top: 16px; margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .lead-notes {
      width: 100%; min-height: 240px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 14px; outline: none;
      font-family: inherit; font-size: 14px;
      resize: vertical;
      transition: all 0.2s;
    }
    .lead-notes:focus {
      border-color: rgba(255,122,24,0.4);
      box-shadow: 0 0 0 3px rgba(255,122,24,0.15);
    }
    .lead-toast {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      min-height: 18px;
      transition: opacity 0.3s;
    }
    @media (max-width: 980px) {
      .lead-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="admin-wrap">
    <div class="admin-bg"></div>

    <header class="admin-top">
      <div class="dashboard-header">
        <div class="header-logo"><img src="/assets/img/cerberus-mark.png" alt="Cerberus"></div>
        <div class="admin-brand">
          <div class="admin-title" id="title">Lead</div>
          <div class="admin-sub">Sistema activo &bull; Detalle del cliente</div>
        </div>
      </div>
      <div class="admin-actions">
        <a class="btn btn--ghost" href="./dashboard">&#x1F3E0; Dashboard</a>
        <a class="btn btn--ghost" href="./support" id="navSupport" style="display:none;">&#x1F3AB; Soporte</a>
        <a class="btn btn--ghost" href="./logout">Cerrar sesion</a>
      </div>
    </header>

    <div class="lead-grid" style="width:min(1200px,calc(100% - 40px));margin:0 auto;">
      <section class="admin-card" style="padding:24px;">
        <div class="lead-field">
          <div class="lead-label">Nombre</div>
          <div class="lead-value" id="vName">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Correo</div>
          <div class="lead-value" id="vEmail">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Telefono</div>
          <div class="lead-value" id="vPhone">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Tipo de proyecto</div>
          <div class="lead-value" id="vType">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Fecha</div>
          <div class="lead-value" id="vDate">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Estado</div>
          <div class="lead-value" id="vStatus">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Mensaje</div>
          <div class="lead-value" id="vMsg">—</div>
        </div>

        <div class="lead-actions">
          <button class="small-btn" id="btnImportant">Importante</button>
          <button class="small-btn" id="btnReplied">Respondido</button>
          <button class="small-btn" id="btnClosed">Cerrar</button>
          <button class="small-btn danger" id="btnDelete">Eliminar</button>
        </div>

        <div class="lead-toast" id="toast"></div>
      </section>

      <section class="admin-card" style="padding:24px;">
        <div class="lead-label" style="margin-bottom:12px;">Notas internas (solo tu)</div>
        <textarea class="lead-notes" id="notes" placeholder="Escribe aqui tus notas..."></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:12px;">
          <button class="btn" id="btnSaveNotes">Guardar notas</button>
        </div>
        <div class="lead-toast" id="toast2"></div>
      </section>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    const el = (sel) => document.getElementById(sel);
    const toast = el("toast");
    const toast2 = el("toast2");

    function badge(status) {
      if (status === "new") return '<span class="badge new">Nuevo</span>';
      if (status === "replied") return '<span class="badge replied">Respondido</span>';
      return '<span class="badge closed">Cerrado</span>';
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString("es-MX", {
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
      } catch { return iso || ""; }
    }

    function showToast(target, msg) {
      target.textContent = msg;
      setTimeout(() => { target.textContent = ""; }, 3000);
    }

    let lead = null;

    async function load() {
      if (!id) {
        showToast(toast, "Falta id en la URL");
        return;
      }
      const r = await fetch(`./api/leads/${id}`);
      const j = await r.json();
      if (!j.ok) {
        showToast(toast, "No se encontro el lead");
        return;
      }
      lead = j.lead;

      el("title").textContent = `Lead #${lead.id}`;
      el("vName").textContent = lead.name || "—";
      el("vEmail").innerHTML = lead.email
        ? `<a href="mailto:${lead.email}">${lead.email}</a>` : "—";
      el("vPhone").textContent = lead.phone || "—";
      el("vType").textContent = lead.project_type || "—";
      el("vDate").textContent = fmtDate(lead.created_at);
      el("vStatus").innerHTML = badge(lead.status);
      el("vMsg").textContent = lead.message || "—";
      el("notes").value = lead.internal_notes || "";

      const bImp = el("btnImportant");
      if (lead.is_important) {
        bImp.textContent = "Importante";
        bImp.classList.add("star-active");
        bImp.style.borderColor = "rgba(255,122,24,0.4)";
        bImp.style.color = "#FFD080";
      } else {
        bImp.textContent = "Importante";
        bImp.classList.remove("star-active");
        bImp.style.borderColor = "";
        bImp.style.color = "";
      }
    }

    async function setStatus(status) {
      await fetch(`./api/leads/${id}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });
      await load();
      showToast(toast, "Estado actualizado");
    }

    async function toggleImportant() {
      await fetch(`./api/leads/${id}/important`, { method: "POST" });
      await load();
      showToast(toast, "Importancia actualizada");
    }

    async function saveNotes() {
      const text = el("notes").value;
      const r = await fetch(`./api/leads/${id}/notes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notes: text })
      });
      if (r.ok) {
        showToast(toast2, "Notas guardadas");
      } else {
        showToast(toast2, "Error al guardar");
      }
    }

    async function del() {
      const ok = await showConfirm("Eliminar lead", "Este lead se eliminara permanentemente junto con todas sus notas.");
      if (!ok) return;
      await fetch(`./api/leads/${id}/delete`, { method: "POST" });
      location.href = "./dashboard";
    }

    // ── Confirmation Modal ──
    function showConfirm(title, text) {
      return new Promise(resolve => {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const textEl = document.getElementById("confirmText");
        const okBtn = document.getElementById("confirmOk");
        const cancelBtn = document.getElementById("confirmCancel");
        const backdrop = modal.querySelector(".confirm-modal-backdrop");

        titleEl.textContent = title || "Confirmar accion";
        textEl.textContent = text || "Esta accion no se puede deshacer.";
        modal.classList.add("is-open");

        function close(result) {
          modal.classList.remove("is-open");
          okBtn.removeEventListener("click", onOk);
          cancelBtn.removeEventListener("click", onCancel);
          backdrop.removeEventListener("click", onCancel);
          resolve(result);
        }

        function onOk() { close(true); }
        function onCancel() { close(false); }

        okBtn.addEventListener("click", onOk);
        cancelBtn.addEventListener("click", onCancel);
        backdrop.addEventListener("click", onCancel);
      });
    }

    el("btnReplied").addEventListener("click", () => setStatus("replied"));
    el("btnClosed").addEventListener("click", () => setStatus("closed"));
    el("btnImportant").addEventListener("click", toggleImportant);
    el("btnSaveNotes").addEventListener("click", saveNotes);
    el("btnDelete").addEventListener("click", del);

    // Role-based nav visibility
    (async function() {
      try {
        const res = await fetch('./api/session');
        const data = await res.json();
        if (data.ok) {
          const role = data.user.role;
          if (role === 'admin' || role === 'support') {
            document.getElementById('navSupport').style.display = '';
          }
        }
      } catch (e) {}
    })();

    load().catch(err => {
      console.error(err);
      showToast(toast, "Error cargando el lead");
    });
  </script>

  <!-- Confirmation Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-backdrop"></div>
    <div class="confirm-modal-box">
      <div class="confirm-modal-icon">&#x26A0;</div>
      <div class="confirm-modal-title" id="confirmTitle">Confirmar accion</div>
      <div class="confirm-modal-text" id="confirmText">Esta accion no se puede deshacer.</div>
      <div class="confirm-modal-actions">
        <button class="confirm-modal-btn cancel" id="confirmCancel" title="Cancelar">&#x2715;</button>
        <button class="confirm-modal-btn confirm" id="confirmOk" title="Confirmar">&#x2713;</button>
      </div>
    </div>
  </div>
</body>
</html>
