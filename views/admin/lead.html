<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" sizes="192x192" href="/assets/img/favicon.png">
  <title>Cerberus Control Room | Lead</title>
  <link rel="stylesheet" href="/assets/css/styles.css"/>
  <link rel="stylesheet" href="/assets/css/admin.css"/>
  <style>
    .lead-grid {
      display: grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      margin-top: 16px;
    }
    .lead-field { margin-bottom: 16px; }
    .lead-label {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.08em; color: rgba(255,255,255,0.5);
      margin-bottom: 6px;
    }
    .lead-value {
      font-size: 15px; line-height: 1.7;
      color: rgba(255,255,255,0.88);
      white-space: pre-wrap;
    }
    .lead-value a {
      color: #FF9A45;
      text-decoration: none;
    }
    .lead-value a:hover { text-decoration: underline; }
    .lead-actions {
      display: flex; gap: 8px; flex-wrap: wrap;
      padding-top: 16px; margin-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .lead-notes {
      width: 100%; min-height: 240px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.9);
      border-radius: 10px;
      padding: 14px; outline: none;
      font-family: inherit; font-size: 14px;
      resize: vertical;
      transition: all 0.2s;
    }
    .lead-notes:focus {
      border-color: rgba(255,122,24,0.4);
      box-shadow: 0 0 0 3px rgba(255,122,24,0.15);
    }
    .lead-toast {
      margin-top: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      min-height: 18px;
      transition: opacity 0.3s;
    }
    @media (max-width: 980px) {
      .lead-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main class="admin-wrap">
    <div class="admin-bg"></div>

    <header class="admin-top">
      <div class="admin-brand">
        <div class="admin-title" id="title">Lead</div>
        <div class="admin-sub">Detalle del cliente</div>
      </div>
      <div class="admin-actions">
        <a class="btn btn--ghost" href="./dashboard">Volver al panel</a>
      </div>
    </header>

    <div class="lead-grid" style="width:min(1200px,calc(100% - 40px));margin:0 auto;">
      <section class="admin-card" style="padding:24px;">
        <div class="lead-field">
          <div class="lead-label">Nombre</div>
          <div class="lead-value" id="vName">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Correo</div>
          <div class="lead-value" id="vEmail">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Telefono</div>
          <div class="lead-value" id="vPhone">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Tipo de proyecto</div>
          <div class="lead-value" id="vType">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Fecha</div>
          <div class="lead-value" id="vDate">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Estado</div>
          <div class="lead-value" id="vStatus">—</div>
        </div>
        <div class="lead-field">
          <div class="lead-label">Mensaje</div>
          <div class="lead-value" id="vMsg">—</div>
        </div>

        <div class="lead-actions">
          <button class="small-btn" id="btnImportant">Importante</button>
          <button class="small-btn" id="btnReplied">Respondido</button>
          <button class="small-btn" id="btnClosed">Cerrar</button>
          <button class="small-btn danger" id="btnDelete">Eliminar</button>
        </div>

        <div class="lead-toast" id="toast"></div>
      </section>

      <section class="admin-card" style="padding:24px;">
        <div class="lead-label" style="margin-bottom:12px;">Notas internas (solo tu)</div>
        <textarea class="lead-notes" id="notes" placeholder="Escribe aqui tus notas..."></textarea>
        <div style="display:flex;justify-content:flex-end;margin-top:12px;">
          <button class="btn" id="btnSaveNotes">Guardar notas</button>
        </div>
        <div class="lead-toast" id="toast2"></div>
      </section>
    </div>
  </main>

  <script>
    const qs = new URLSearchParams(location.search);
    const id = qs.get("id");

    const el = (sel) => document.getElementById(sel);
    const toast = el("toast");
    const toast2 = el("toast2");

    function badge(status) {
      if (status === "new") return '<span class="badge new">Nuevo</span>';
      if (status === "replied") return '<span class="badge replied">Respondido</span>';
      return '<span class="badge closed">Cerrado</span>';
    }

    function fmtDate(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString("es-MX", {
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
      } catch { return iso || ""; }
    }

    function showToast(target, msg) {
      target.textContent = msg;
      setTimeout(() => { target.textContent = ""; }, 3000);
    }

    let lead = null;

    async function load() {
      if (!id) {
        showToast(toast, "Falta id en la URL");
        return;
      }
      const r = await fetch(`./api/leads/${id}`);
      const j = await r.json();
      if (!j.ok) {
        showToast(toast, "No se encontro el lead");
        return;
      }
      lead = j.lead;

      el("title").textContent = `Lead #${lead.id}`;
      el("vName").textContent = lead.name || "—";
      el("vEmail").innerHTML = lead.email
        ? `<a href="mailto:${lead.email}">${lead.email}</a>` : "—";
      el("vPhone").textContent = lead.phone || "—";
      el("vType").textContent = lead.project_type || "—";
      el("vDate").textContent = fmtDate(lead.created_at);
      el("vStatus").innerHTML = badge(lead.status);
      el("vMsg").textContent = lead.message || "—";
      el("notes").value = lead.internal_notes || "";

      const bImp = el("btnImportant");
      if (lead.is_important) {
        bImp.textContent = "Importante";
        bImp.classList.add("star-active");
        bImp.style.borderColor = "rgba(255,122,24,0.4)";
        bImp.style.color = "#FFD080";
      } else {
        bImp.textContent = "Importante";
        bImp.classList.remove("star-active");
        bImp.style.borderColor = "";
        bImp.style.color = "";
      }
    }

    async function setStatus(status) {
      await fetch(`./api/leads/${id}/status`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });
      await load();
      showToast(toast, "Estado actualizado");
    }

    async function toggleImportant() {
      await fetch(`./api/leads/${id}/important`, { method: "POST" });
      await load();
      showToast(toast, "Importancia actualizada");
    }

    async function saveNotes() {
      const text = el("notes").value;
      const r = await fetch(`./api/leads/${id}/notes`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ notes: text })
      });
      if (r.ok) {
        showToast(toast2, "Notas guardadas");
      } else {
        showToast(toast2, "Error al guardar");
      }
    }

    async function del() {
      if (!confirm("Eliminar definitivamente este lead?")) return;
      await fetch(`./api/leads/${id}/delete`, { method: "POST" });
      location.href = "./dashboard";
    }

    el("btnReplied").addEventListener("click", () => setStatus("replied"));
    el("btnClosed").addEventListener("click", () => setStatus("closed"));
    el("btnImportant").addEventListener("click", toggleImportant);
    el("btnSaveNotes").addEventListener("click", saveNotes);
    el("btnDelete").addEventListener("click", del);

    load().catch(err => {
      console.error(err);
      showToast(toast, "Error cargando el lead");
    });
  </script>
</body>
</html>
