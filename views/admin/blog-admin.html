<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" sizes="192x192" href="/assets/img/favicon.png">
  <title>Cerberus Control Room – Blog</title>
  <link rel="stylesheet" href="/assets/css/styles.css"/>
  <link rel="stylesheet" href="/assets/css/admin.css"/>
  <style>
    /* Futuristic Background */
    .admin-bg::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,122,24,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,122,24,0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 40%, transparent 100%);
      -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 40%, transparent 100%);
      pointer-events: none;
    }
    .admin-bg::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,122,24,0.4), transparent);
      animation: scanline 8s linear infinite;
      opacity: 0.6;
      pointer-events: none;
    }
    @keyframes scanline {
      0% { top: 0; opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      100% { top: 100%; opacity: 0; }
    }
    /* Enhanced header layout */
    .admin-top {
      flex-direction: row !important;
      align-items: center !important;
      justify-content: space-between !important;
      flex-wrap: wrap;
      gap: 12px !important;
    }
    .dashboard-header {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .admin-actions {
      width: 100%;
      order: 3;
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .header-logo {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(255,122,24,0.2), rgba(255,122,24,0.05));
      border: 1px solid rgba(255,122,24,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 30px rgba(255,122,24,0.2), inset 0 0 20px rgba(255,122,24,0.1);
      animation: logoPulse 3s ease-in-out infinite;
      padding: 10px;
    }
    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(255,122,24,0.4));
    }
    @keyframes logoPulse {
      0%, 100% { box-shadow: 0 0 30px rgba(255,122,24,0.2), inset 0 0 20px rgba(255,122,24,0.1); }
      50% { box-shadow: 0 0 40px rgba(255,122,24,0.35), inset 0 0 25px rgba(255,122,24,0.15); }
    }
    .admin-title::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 60px;
      height: 3px;
      background: linear-gradient(90deg, #FF7A18, transparent);
      border-radius: 2px;
    }
    .admin-title { position: relative; }
    .admin-sub {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .admin-sub::before {
      content: '';
      width: 6px;
      height: 6px;
      background: #22c55e;
      border-radius: 50%;
      animation: statusBlink 2s ease-in-out infinite;
      box-shadow: 0 0 8px #22c55e;
    }
    @keyframes statusBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Mobile hamburger menu */
    .mobile-menu-toggle {
      display: none;
      width: 44px; height: 40px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      flex-shrink: 0;
    }
    .mobile-menu-toggle span {
      position: absolute;
      left: 12px; right: 12px;
      height: 2px;
      background: rgba(255,255,255,0.8);
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    .mobile-menu-toggle span:nth-child(1) { top: 13px; }
    .mobile-menu-toggle span:nth-child(2) { top: 19px; }
    .mobile-menu-toggle span:nth-child(3) { top: 25px; }
    .mobile-menu-toggle.is-open span:nth-child(1) { top: 19px; transform: rotate(45deg); }
    .mobile-menu-toggle.is-open span:nth-child(2) { opacity: 0; }
    .mobile-menu-toggle.is-open span:nth-child(3) { top: 19px; transform: rotate(-45deg); }

    .mobile-menu-panel {
      display: none;
      position: fixed;
      top: 0; right: 0;
      width: min(280px, 85vw);
      height: 100%;
      background: rgba(12,15,24,0.98);
      border-left: 1px solid rgba(255,122,24,0.3);
      padding: 20px;
      z-index: 9999;
      flex-direction: column;
      gap: 8px;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
    }
    .mobile-menu-panel.is-open { display: flex; transform: translateX(0); }
    .mobile-menu-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      z-index: 9998;
    }
    .mobile-menu-backdrop.is-open { display: block; }
    .mobile-menu-close {
      align-self: flex-end;
      width: 36px; height: 36px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 16px;
    }
    .mobile-menu-panel .btn {
      width: 100%;
      justify-content: flex-start !important;
      padding: 14px 16px !important;
      font-size: 14px !important;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .mobile-menu-toggle { display: block; }
      .admin-actions { display: none !important; }
      .header-right .btn-logout { display: none; }
      .admin-top { padding: 12px 16px !important; }
      .header-logo { width: 44px !important; height: 44px !important; padding: 8px !important; }
      .admin-title { font-size: 16px !important; }
      .admin-sub { font-size: 11px !important; }
    }
    /* Corner accents for cards */
    .admin-card::before,
    .admin-card::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,122,24,0.3);
      pointer-events: none;
    }
    .admin-card::before {
      top: -1px;
      left: -1px;
      border-right: none;
      border-bottom: none;
      border-radius: 16px 0 0 0;
    }
    .admin-card::after {
      bottom: -1px;
      right: -1px;
      border-left: none;
      border-top: none;
      border-radius: 0 0 16px 0;
    }
    .admin-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-card-title::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, #FF7A18, #FF9A45);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <main class="admin-wrap">
    <div class="admin-bg"></div>

    <header class="admin-top">
      <div class="dashboard-header">
        <div class="header-logo"><img src="/assets/img/cerberus-mark.png" alt="Cerberus"></div>
        <div class="admin-brand">
          <div class="admin-title">Blog Manager</div>
          <div class="admin-sub">Sistema activo &bull; Crear y publicar articulos</div>
        </div>
      </div>

      <div class="header-right">
        <a class="btn btn--ghost btn-logout" href="./logout">Cerrar sesion</a>
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Abrir menu">
          <span></span><span></span><span></span>
        </button>
      </div>

      <div class="admin-actions">
        <a class="btn btn--ghost" href="./dashboard">&#x1F3E0; Dashboard</a>
        <a class="btn btn--ghost" href="./users" id="navUsers" style="display:none;">&#x1F465; Usuarios</a>
        <a class="btn btn--ghost" href="./services" id="navServices" style="display:none;">&#x2699; Servicios</a>
        <a class="btn btn--ghost" href="./monitor" id="navMonitor" style="display:none;">&#x1F4CA; Monitor</a>
        <a class="btn btn--ghost" href="./projects-admin">&#x1F4C1; Proyectos</a>
        <a class="btn btn--ghost" href="./leads">&#x1F4E9; Leads</a>
        <a class="btn btn--ghost" href="./tech-admin" id="navTech" style="display:none;">&#x1F527; Tecnologias</a>
      </div>
    </header>

    <!-- Mobile menu backdrop and panel -->
    <div class="mobile-menu-backdrop" id="mobileMenuBackdrop"></div>
    <div class="mobile-menu-panel" id="mobileMenuPanel">
      <button class="mobile-menu-close" id="mobileMenuClose">&#x2715;</button>
      <a class="btn btn--ghost" href="./dashboard">&#x1F3E0; Dashboard</a>
      <a class="btn btn--ghost" href="./users" id="navUsersMobile" style="display:none;">&#x1F465; Usuarios</a>
      <a class="btn btn--ghost" href="./services" id="navServicesMobile" style="display:none;">&#x2699; Servicios</a>
      <a class="btn btn--ghost" href="./monitor" id="navMonitorMobile" style="display:none;">&#x1F4CA; Monitor</a>
      <a class="btn btn--ghost" href="./projects-admin">&#x1F4C1; Proyectos</a>
      <a class="btn btn--ghost" href="./leads">&#x1F4E9; Leads</a>
      <a class="btn btn--ghost" href="./tech-admin" id="navTechMobile" style="display:none;">&#x1F527; Tecnologias</a>
      <a class="btn btn--ghost" href="./logout" style="margin-top: auto;">Cerrar sesion</a>
    </div>

    <!-- Nav tabs -->
    <nav class="admin-nav">
      <button class="admin-nav-btn is-active" data-tab="posts">Publicaciones</button>
      <button class="admin-nav-btn" data-tab="editor">Nuevo articulo</button>
      <button class="admin-nav-btn" data-tab="categories">Categorias</button>
      <button class="admin-nav-btn" data-tab="comments">Comentarios</button>
    </nav>

    <!-- TAB: Posts list -->
    <section class="admin-card" id="tabPosts">
      <div class="admin-card-head">
        <div>
          <div class="admin-card-title">Todas las publicaciones</div>
          <div class="admin-card-sub">Publicados y borradores</div>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table" id="postsTable">
          <thead>
            <tr>
              <th>Titulo</th>
              <th>Categoria</th>
              <th>Estado</th>
              <th class="col-date">Fecha</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="postsTbody"></tbody>
        </table>
      </div>
      <div id="postsEmpty" style="display:none;text-align:center;padding:48px 24px;color:rgba(255,255,255,0.5);">
        No hay publicaciones. Crea tu primer articulo.
      </div>
    </section>

    <!-- TAB: Editor -->
    <section class="admin-card" id="tabEditor" style="display:none;">
      <div class="admin-card-head">
        <div>
          <div class="admin-card-title" id="editorTitle">Nuevo articulo</div>
          <div class="admin-card-sub">Escribe y publica contenido para el blog</div>
        </div>
      </div>
      <div style="padding:24px;">
        <form class="admin-form" id="postForm">
          <input type="hidden" name="id" id="postId"/>
          <div class="admin-form-row">
            <div class="field">
              <label>Titulo (Español)</label>
              <input name="title" id="postTitleInput" required placeholder="Titulo del articulo"/>
            </div>
            <div class="field">
              <label>Title (English)</label>
              <input name="title_en" id="postTitleEn" placeholder="Article title in English"/>
            </div>
          </div>
          <div class="admin-form-row">
            <div class="field">
              <label>Slug (URL)</label>
              <input name="slug" id="postSlug" placeholder="se-genera-automaticamente"/>
            </div>
            <div class="field">
              <label>Categoria</label>
              <select name="category_id" id="postCategory">
                <option value="">Sin categoria</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>Imagen destacada</label>
            <input type="hidden" name="image_url" id="postImage"/>
            <div class="upload-zone" id="blogUploadZone">
              <div class="upload-icon">
                <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/>
                </svg>
              </div>
              <div class="upload-text">Arrastra una imagen aqui o <span class="upload-link">selecciona un archivo</span></div>
              <input type="file" id="blogFileInput" accept="image/*" style="display:none;"/>
            </div>
            <div class="upload-preview" id="blogPreview" style="display:none;">
              <img id="blogPreviewImg" src="" alt="Preview">
              <button type="button" class="upload-preview-remove" id="blogRemoveImg">&times;</button>
            </div>
          </div>
          <div class="admin-form-row">
            <div class="field">
              <label>Extracto (Español)</label>
              <input name="excerpt" id="postExcerpt" placeholder="Breve descripcion del articulo"/>
            </div>
            <div class="field">
              <label>Excerpt (English)</label>
              <input name="excerpt_en" id="postExcerptEn" placeholder="Brief article description"/>
            </div>
          </div>
          <div class="admin-form-row">
            <div class="field">
              <label>Contenido (Español - HTML)</label>
              <textarea name="content" id="postContent" rows="10" placeholder="Escribe el contenido del articulo en HTML..."></textarea>
            </div>
            <div class="field">
              <label>Content (English - HTML)</label>
              <textarea name="content_en" id="postContentEn" rows="10" placeholder="Write article content in HTML..."></textarea>
            </div>
          </div>
          <div style="display:flex;gap:12px;align-items:center;margin-top:12px;">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px;color:rgba(255,255,255,0.7);">
              <input type="checkbox" name="is_published" id="postPublished" value="1"/>
              Publicar (visible en el blog)
            </label>
          </div>
          <div style="display:flex;gap:12px;margin-top:24px;">
            <button class="btn" type="submit">Guardar</button>
            <button class="btn btn--ghost" type="button" id="cancelEdit">Cancelar</button>
          </div>
        </form>
      </div>
    </section>

    <!-- TAB: Comments -->
    <section class="admin-card" id="tabComments" style="display:none;">
      <div class="admin-card-head">
        <div>
          <div class="admin-card-title">Comentarios del blog</div>
          <div class="admin-card-sub">Aprueba o elimina comentarios de los visitantes</div>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table" id="commentsTable">
          <thead>
            <tr>
              <th>Autor</th>
              <th>Comentario</th>
              <th>Articulo</th>
              <th>Estado</th>
              <th class="col-date">Fecha</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="commentsTbody"></tbody>
        </table>
      </div>
      <div id="commentsEmpty" style="display:none;text-align:center;padding:48px 24px;color:rgba(255,255,255,0.5);">
        Sin comentarios todavia.
      </div>
    </section>

    <!-- TAB: Categories -->
    <section class="admin-card" id="tabCategories" style="display:none;">
      <div class="admin-card-head">
        <div>
          <div class="admin-card-title">Categorias</div>
          <div class="admin-card-sub">Organiza tus publicaciones</div>
        </div>
      </div>
      <div style="padding:24px;">
        <form id="catForm" style="display:flex;gap:12px;margin-bottom:24px;max-width:400px;">
          <input name="name" required placeholder="Nueva categoria" style="flex:1;padding:12px 16px;font-family:inherit;font-size:14px;color:rgba(255,255,255,0.9);background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.10);border-radius:10px;outline:none;"/>
          <button class="btn" type="submit" style="padding:12px 24px;">Crear</button>
        </form>
        <div id="catList" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
    </section>
  </main>

  <script>
  const $ = (q) => document.querySelector(q);
  let allPosts = [];
  let allCats = [];

  // ── Tabs ──
  document.querySelectorAll("[data-tab]").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll("[data-tab]").forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");
      const tab = btn.dataset.tab;
      document.getElementById("tabPosts").style.display = tab === "posts" ? "" : "none";
      document.getElementById("tabEditor").style.display = tab === "editor" ? "" : "none";
      document.getElementById("tabCategories").style.display = tab === "categories" ? "" : "none";
      document.getElementById("tabComments").style.display = tab === "comments" ? "" : "none";

      if (tab === "editor") resetForm();
      if (tab === "comments") loadComments();
    });
  });

  function showTab(name) {
    document.querySelectorAll("[data-tab]").forEach(b => {
      b.classList.toggle("is-active", b.dataset.tab === name);
    });
    document.getElementById("tabPosts").style.display = name === "posts" ? "" : "none";
    document.getElementById("tabEditor").style.display = name === "editor" ? "" : "none";
    document.getElementById("tabCategories").style.display = name === "categories" ? "" : "none";
    document.getElementById("tabComments").style.display = name === "comments" ? "" : "none";
  }

  // ── API helper ──
  async function api(url, opts) {
    const res = await fetch(url, opts);
    return res.json();
  }

  // ── Load data ──
  async function loadAll() {
    const [postsRes, catsRes] = await Promise.all([
      api("./api/blog/posts"),
      api("./api/blog/categories")
    ]);
    allPosts = postsRes.posts || [];
    allCats = catsRes.categories || [];
    renderPosts();
    renderCats();
    renderCatSelect();
  }

  // ── Render posts table ──
  function renderPosts() {
    const tbody = $("#postsTbody");
    const empty = $("#postsEmpty");

    if (allPosts.length === 0) {
      tbody.innerHTML = "";
      empty.style.display = "";
      return;
    }
    empty.style.display = "none";

    tbody.innerHTML = allPosts.map(p => `
      <tr>
        <td><strong>${esc(p.title)}</strong></td>
        <td>${esc(p.category_name || "—")}</td>
        <td>${Number(p.is_published) === 1
          ? '<span class="badge replied">Publicado</span>'
          : '<span class="badge">Borrador</span>'
        }</td>
        <td class="col-date">${fmtDate(p.created_at)}</td>
        <td class="col-actions">
          <div class="row-actions">
            <button class="small-btn" data-edit="${p.id}">Editar</button>
            <button class="small-btn danger" data-delete="${p.id}">Eliminar</button>
          </div>
        </td>
      </tr>
    `).join("");

    // Bind edit/delete
    tbody.querySelectorAll("[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => editPost(Number(btn.dataset.edit)));
    });
    tbody.querySelectorAll("[data-delete]").forEach(btn => {
      btn.addEventListener("click", () => deletePost(Number(btn.dataset.delete)));
    });
  }

  // ── Render categories ──
  function renderCats() {
    const wrap = $("#catList");
    if (allCats.length === 0) {
      wrap.innerHTML = '<span style="color:rgba(255,255,255,0.4);">Sin categorias aun.</span>';
      return;
    }
    wrap.innerHTML = allCats.map(c => `
      <div class="chip is-on" style="cursor:default;display:inline-flex;align-items:center;gap:8px;">
        ${esc(c.name)}
        <button type="button" data-delete-cat="${c.id}" title="Eliminar" style="background:none;border:none;color:rgba(255,255,255,0.4);cursor:pointer;padding:0;font-size:14px;line-height:1;">&times;</button>
      </div>
    `).join("");

    // Add delete handlers
    wrap.querySelectorAll("[data-delete-cat]").forEach(btn => {
      btn.addEventListener("click", () => deleteCategory(Number(btn.dataset.deleteCat)));
    });
  }

  // ── Delete category ──
  async function deleteCategory(id) {
    const cat = allCats.find(c => c.id === id);
    if (!cat) return;

    const res = await api(`./api/blog/categories/${id}/delete`, { method: "POST" });
    if (!res.ok && res.error === 'has_posts') {
      const force = await showConfirm(
        "Categoria con articulos",
        `Esta categoria tiene ${res.postCount} articulo(s). Si la eliminas, los articulos quedaran sin categoria. ¿Continuar?`
      );
      if (force) {
        await api(`./api/blog/categories/${id}/delete`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ force: true })
        });
        await loadAll();
      }
    } else {
      await loadAll();
    }
  }

  function renderCatSelect() {
    const sel = $("#postCategory");
    const val = sel.value;
    sel.innerHTML = '<option value="">Sin categoria</option>';
    allCats.forEach(c => {
      sel.innerHTML += `<option value="${c.id}">${esc(c.name)}</option>`;
    });
    sel.value = val;
  }

  // ── Edit post ──
  function editPost(id) {
    const p = allPosts.find(x => x.id === id);
    if (!p) return;
    $("#postId").value = p.id;
    $("#postTitleInput").value = p.title;
    $("#postTitleEn").value = p.title_en || "";
    $("#postSlug").value = p.slug || "";
    $("#postExcerpt").value = p.excerpt || "";
    $("#postExcerptEn").value = p.excerpt_en || "";
    $("#postContent").value = p.content || "";
    $("#postContentEn").value = p.content_en || "";
    $("#postCategory").value = p.category_id || "";
    $("#postImage").value = p.image_url || "";
    $("#postPublished").checked = Number(p.is_published) === 1;
    $("#editorTitle").textContent = "Editar articulo";
    showImagePreview(p.image_url);
    showTab("editor");
  }

  // ── Delete post ──
  async function deletePost(id) {
    const ok = await showConfirm("Eliminar publicacion", "Esta publicacion se eliminara permanentemente.");
    if (!ok) return;
    await api(`./api/blog/posts/${id}/delete`, { method: "POST" });
    await loadAll();
  }

  // ── Form submit ──
  $("#postForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const payload = {
      id: fd.get("id") || null,
      title: fd.get("title"),
      title_en: fd.get("title_en") || null,
      slug: fd.get("slug"),
      excerpt: fd.get("excerpt"),
      excerpt_en: fd.get("excerpt_en") || null,
      content: fd.get("content"),
      content_en: fd.get("content_en") || null,
      category_id: fd.get("category_id") || null,
      image_url: fd.get("image_url"),
      is_published: fd.get("is_published") === "1"
    };

    const btn = e.target.querySelector('button[type="submit"]');
    btn.textContent = "Guardando...";
    btn.disabled = true;

    try {
      await api("./api/blog/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      resetForm();
      await loadAll();
      showTab("posts");
    } catch (err) {
      alert("Error al guardar: " + err.message);
    } finally {
      btn.textContent = "Guardar";
      btn.disabled = false;
    }
  });

  function resetForm() {
    $("#postForm").reset();
    $("#postId").value = "";
    $("#postImage").value = "";
    $("#postTitleEn").value = "";
    $("#postExcerptEn").value = "";
    $("#postContentEn").value = "";
    $("#editorTitle").textContent = "Nuevo articulo";
    showImagePreview(null);
  }

  $("#cancelEdit").addEventListener("click", () => {
    resetForm();
    showTab("posts");
  });

  // ── Category form ──
  $("#catForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = e.target.name.value.trim();
    if (!name) return;

    await api("./api/blog/categories", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name })
    });
    e.target.reset();
    await loadAll();
  });

  // ── Auto-slug ──
  $("#postTitleInput").addEventListener("input", () => {
    if (!$("#postId").value) {
      const t = $("#postTitleInput").value;
      $("#postSlug").value = t.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9]+/g, "-").replace(/^-|-$/g, "");
    }
  });

  // ── Helpers ──
  function esc(s) {
    return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
  }

  function fmtDate(iso) {
    try {
      return new Date(iso).toLocaleString("es-MX", { year: "numeric", month: "2-digit", day: "2-digit" });
    } catch { return iso || ""; }
  }

  // ── Comments ──
  let allComments = [];

  async function loadComments() {
    try {
      const res = await api("./api/blog/comments");
      allComments = res.comments || [];
      renderComments();
    } catch (err) {
      console.error(err);
    }
  }

  function renderComments() {
    const tbody = $("#commentsTbody");
    const empty = $("#commentsEmpty");

    if (allComments.length === 0) {
      tbody.innerHTML = "";
      empty.style.display = "";
      return;
    }
    empty.style.display = "none";

    tbody.innerHTML = allComments.map(c => `
      <tr>
        <td><strong>${esc(c.author_name)}</strong></td>
        <td style="max-width:300px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${esc(c.comment)}</td>
        <td>${esc(c.post_title || "—")}</td>
        <td>${Number(c.is_approved) === 1
          ? '<span class="badge replied">Aprobado</span>'
          : '<span class="badge new">Pendiente</span>'
        }</td>
        <td class="col-date">${fmtDate(c.created_at)}</td>
        <td class="col-actions">
          <div class="row-actions">
            ${Number(c.is_approved) !== 1
              ? `<button class="small-btn" data-approve="${c.id}">Aprobar</button>`
              : `<button class="small-btn" data-reject="${c.id}">Rechazar</button>`
            }
            <button class="small-btn danger" data-del-comment="${c.id}">Eliminar</button>
          </div>
        </td>
      </tr>
    `).join("");

    tbody.querySelectorAll("[data-approve]").forEach(btn => {
      btn.addEventListener("click", async () => {
        await api(`./api/blog/comments/${btn.dataset.approve}/approve`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ approved: true })
        });
        loadComments();
      });
    });
    tbody.querySelectorAll("[data-reject]").forEach(btn => {
      btn.addEventListener("click", async () => {
        await api(`./api/blog/comments/${btn.dataset.reject}/approve`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ approved: false })
        });
        loadComments();
      });
    });
    tbody.querySelectorAll("[data-del-comment]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const ok = await showConfirm("Eliminar comentario", "Este comentario se eliminara permanentemente.");
        if (!ok) return;
        await api(`./api/blog/comments/${btn.dataset.delComment}/delete`, { method: "POST" });
        loadComments();
      });
    });
  }

  // ── Image Upload ──
  const uploadZone = $("#blogUploadZone");
  const fileInput = $("#blogFileInput");
  const preview = $("#blogPreview");
  const previewImg = $("#blogPreviewImg");
  const removeBtn = $("#blogRemoveImg");
  const imageInput = $("#postImage");

  uploadZone.addEventListener("click", () => fileInput.click());
  uploadZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadZone.classList.add("drag-over");
  });
  uploadZone.addEventListener("dragleave", () => {
    uploadZone.classList.remove("drag-over");
  });
  uploadZone.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadZone.classList.remove("drag-over");
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith("image/")) {
      uploadImage(file);
    }
  });
  fileInput.addEventListener("change", () => {
    if (fileInput.files[0]) {
      uploadImage(fileInput.files[0]);
    }
  });
  removeBtn.addEventListener("click", () => {
    imageInput.value = "";
    preview.style.display = "none";
    uploadZone.style.display = "";
  });

  async function uploadImage(file) {
    const fd = new FormData();
    fd.append("image", file);
    uploadZone.innerHTML = '<div style="color:var(--orange);">Subiendo...</div>';
    try {
      const res = await fetch("./api/upload", { method: "POST", body: fd });
      const data = await res.json();
      if (data.ok && data.url) {
        imageInput.value = data.url;
        previewImg.src = data.url;
        preview.style.display = "";
        uploadZone.style.display = "none";
      } else {
        alert("Error al subir imagen");
      }
    } catch (err) {
      alert("Error al subir: " + err.message);
    } finally {
      uploadZone.innerHTML = `
        <div class="upload-icon">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
            <path d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"/>
          </svg>
        </div>
        <div class="upload-text">Arrastra una imagen aqui o <span class="upload-link">selecciona un archivo</span></div>
      `;
    }
  }

  function showImagePreview(url) {
    if (url) {
      previewImg.src = url;
      preview.style.display = "";
      uploadZone.style.display = "none";
    } else {
      preview.style.display = "none";
      uploadZone.style.display = "";
    }
  }

  // ── Init ──
  loadAll().catch(err => console.error(err));

  // Show admin navigation based on role
  (async function() {
    try {
      const res = await fetch('./api/session');
      const data = await res.json();
      if (data.ok) {
        const role = data.user.role;
        if (role === 'admin') {
          document.getElementById('navUsers').style.display = '';
          document.getElementById('navServices').style.display = '';
          document.getElementById('navMonitor').style.display = '';
          document.getElementById('navTech').style.display = '';
          document.getElementById('navUsersMobile').style.display = '';
          document.getElementById('navServicesMobile').style.display = '';
          document.getElementById('navMonitorMobile').style.display = '';
          document.getElementById('navTechMobile').style.display = '';
        } else if (role === 'support') {
          document.getElementById('navServices').style.display = '';
          document.getElementById('navMonitor').style.display = '';
          document.getElementById('navServicesMobile').style.display = '';
          document.getElementById('navMonitorMobile').style.display = '';
        }
      }
    } catch (err) {
      console.warn('Could not load session:', err);
    }
  })();

  // Mobile menu toggle
  (function() {
    const toggle = document.getElementById('mobileMenuToggle');
    const panel = document.getElementById('mobileMenuPanel');
    const backdrop = document.getElementById('mobileMenuBackdrop');
    const closeBtn = document.getElementById('mobileMenuClose');
    if (!toggle || !panel) return;

    function openMenu() {
      toggle.classList.add('is-open');
      panel.classList.add('is-open');
      backdrop.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    }
    function closeMenu() {
      toggle.classList.remove('is-open');
      panel.classList.remove('is-open');
      backdrop.classList.remove('is-open');
      document.body.style.overflow = '';
    }

    toggle.addEventListener('click', () => {
      if (panel.classList.contains('is-open')) closeMenu();
      else openMenu();
    });
    closeBtn?.addEventListener('click', closeMenu);
    backdrop?.addEventListener('click', closeMenu);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeMenu(); });
  })();

  // ── Confirmation Modal ──
  function showConfirm(title, text) {
    return new Promise(resolve => {
      const modal = $("#confirmModal");
      const titleEl = $("#confirmTitle");
      const textEl = $("#confirmText");
      const okBtn = $("#confirmOk");
      const cancelBtn = $("#confirmCancel");
      const backdrop = modal.querySelector(".confirm-modal-backdrop");

      titleEl.textContent = title || "Confirmar accion";
      textEl.textContent = text || "Esta accion no se puede deshacer.";
      modal.classList.add("is-open");

      function close(result) {
        modal.classList.remove("is-open");
        okBtn.removeEventListener("click", onOk);
        cancelBtn.removeEventListener("click", onCancel);
        backdrop.removeEventListener("click", onCancel);
        resolve(result);
      }

      function onOk() { close(true); }
      function onCancel() { close(false); }

      okBtn.addEventListener("click", onOk);
      cancelBtn.addEventListener("click", onCancel);
      backdrop.addEventListener("click", onCancel);
    });
  }
  </script>

  <!-- Confirmation Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-backdrop"></div>
    <div class="confirm-modal-box">
      <div class="confirm-modal-icon">&#x26A0;</div>
      <div class="confirm-modal-title" id="confirmTitle">Confirmar accion</div>
      <div class="confirm-modal-text" id="confirmText">Esta accion no se puede deshacer.</div>
      <div class="confirm-modal-actions">
        <button class="confirm-modal-btn cancel" id="confirmCancel" title="Cancelar">&#x2715;</button>
        <button class="confirm-modal-btn confirm" id="confirmOk" title="Confirmar">&#x2713;</button>
      </div>
    </div>
  </div>
</body>
</html>
