<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cerberus Dev | Proyecto</title>
  <link rel="icon" sizes="192x192" href="/assets/img/favicon.png">
  <link rel="stylesheet" href="/assets/css/styles.css"/>
  <style>
    /* Modern Image Gallery */
    .proj-gallery {
      margin-bottom: 32px;
    }
    .proj-gallery-main {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 16px;
      overflow: hidden;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      cursor: zoom-in;
    }
    .proj-gallery-main img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: opacity 0.4s ease;
    }
    .proj-gallery-main img.fade-out {
      opacity: 0;
    }
    .proj-gallery-thumbs {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      overflow-x: auto;
      padding-bottom: 8px;
    }
    .proj-gallery-thumb {
      flex-shrink: 0;
      width: 80px;
      height: 56px;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      opacity: 0.6;
    }
    .proj-gallery-thumb:hover {
      opacity: 0.9;
    }
    .proj-gallery-thumb.is-active {
      border-color: var(--orange);
      opacity: 1;
    }
    .proj-gallery-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .proj-gallery-counter {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Lightbox */
    .lightbox {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .lightbox.is-open {
      opacity: 1;
      visibility: visible;
    }
    .lightbox-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }
    .lightbox-content img {
      max-width: 90vw;
      max-height: 85vh;
      object-fit: contain;
      border-radius: 8px;
    }
    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .lightbox-close:hover {
      background: rgba(255,255,255,0.2);
    }
    .lightbox-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 48px;
      height: 48px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .lightbox-nav:hover {
      background: rgba(255,122,24,0.4);
    }
    .lightbox-nav.prev { left: -60px; }
    .lightbox-nav.next { right: -60px; }
    .lightbox-counter {
      position: absolute;
      bottom: -36px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }
    @media (max-width: 768px) {
      .lightbox-nav.prev { left: 10px; }
      .lightbox-nav.next { right: 10px; }
    }
  </style>
</head>
<body>
  <div data-include="/partials/header.html"></div>

  <main class="page">
    <section class="hero hero--small">
      <div class="hero-bg"></div>
      <div class="container">
        <div class="hero-content">
          <a href="/proyectos" class="section-label" data-reveal style="text-decoration:none;" data-i18n="projects.back_link">&larr; Volver a proyectos</a>
          <h1 class="h-title" data-reveal id="projTitle">Cargando...</h1>
          <p class="h-sub" data-reveal id="projMeta"></p>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top:32px;">
      <div class="container">
        <!-- Image Gallery -->
        <div class="proj-gallery" id="projGallery" style="display:none;">
          <div class="proj-gallery-main" id="galleryMain">
            <img id="galleryMainImg" src="" alt="">
            <div class="proj-gallery-counter" id="galleryCounter">1 / 1</div>
          </div>
          <div class="proj-gallery-thumbs" id="galleryThumbs"></div>
        </div>

        <article class="blog-post" id="projContent">
          <div style="text-align:center;color:rgba(255,255,255,0.4);padding:40px;">Cargando proyecto...</div>
        </article>

        <!-- Technologies used -->
        <div class="proj-techs-section" id="projTechsSection" style="display:none;">
          <h3 class="proj-techs-title" id="projTechsTitle">Tecnologias utilizadas</h3>
          <div class="proj-techs-grid" id="projTechsGrid"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-content">
      <button class="lightbox-close" id="lightboxClose">&times;</button>
      <button class="lightbox-nav prev" id="lightboxPrev">&#8249;</button>
      <img id="lightboxImg" src="" alt="">
      <button class="lightbox-nav next" id="lightboxNext">&#8250;</button>
      <div class="lightbox-counter" id="lightboxCounter">1 / 1</div>
    </div>
  </div>

  <div data-include="/partials/footer.html"></div>
  <script src="/assets/js/i18n-data.js"></script>
  <script src="/assets/js/main.js"></script>
  <script>
  (function() {
    const parts = location.pathname.split("/").filter(Boolean);
    const slug = parts[1];
    if (!slug || slug === "proyectos") return;

    const projTitle = document.getElementById("projTitle");
    const projMeta = document.getElementById("projMeta");
    const projContent = document.getElementById("projContent");
    const projTechsSection = document.getElementById("projTechsSection");
    const projTechsGrid = document.getElementById("projTechsGrid");
    const projGallery = document.getElementById("projGallery");
    const galleryMain = document.getElementById("galleryMain");
    const galleryMainImg = document.getElementById("galleryMainImg");
    const galleryThumbs = document.getElementById("galleryThumbs");
    const galleryCounter = document.getElementById("galleryCounter");

    // Lightbox elements
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");
    const lightboxClose = document.getElementById("lightboxClose");
    const lightboxPrev = document.getElementById("lightboxPrev");
    const lightboxNext = document.getElementById("lightboxNext");
    const lightboxCounter = document.getElementById("lightboxCounter");

    let allImages = [];
    let currentIndex = 0;

    function esc(s) {
      return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    function fmtDate(d) {
      try {
        return new Date(d).toLocaleDateString("es-MX", { year:"numeric", month:"long", day:"numeric" });
      } catch { return ""; }
    }

    function updateGallery(index) {
      if (allImages.length === 0) return;
      currentIndex = index;

      // Fade transition
      galleryMainImg.classList.add("fade-out");
      setTimeout(() => {
        galleryMainImg.src = allImages[index];
        galleryMainImg.classList.remove("fade-out");
      }, 200);

      galleryCounter.textContent = `${index + 1} / ${allImages.length}`;

      // Update thumbs
      document.querySelectorAll(".proj-gallery-thumb").forEach((thumb, i) => {
        thumb.classList.toggle("is-active", i === index);
      });
    }

    function openLightbox(index) {
      currentIndex = index;
      lightboxImg.src = allImages[index];
      lightboxCounter.textContent = `${index + 1} / ${allImages.length}`;
      lightbox.classList.add("is-open");
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lightbox.classList.remove("is-open");
      document.body.style.overflow = "";
    }

    function lightboxNav(dir) {
      let newIndex = currentIndex + dir;
      if (newIndex < 0) newIndex = allImages.length - 1;
      if (newIndex >= allImages.length) newIndex = 0;
      currentIndex = newIndex;
      lightboxImg.src = allImages[newIndex];
      lightboxCounter.textContent = `${newIndex + 1} / ${allImages.length}`;
      updateGallery(newIndex);
    }

    // Lightbox events
    lightboxClose.addEventListener("click", closeLightbox);
    lightbox.addEventListener("click", (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    lightboxPrev.addEventListener("click", (e) => { e.stopPropagation(); lightboxNav(-1); });
    lightboxNext.addEventListener("click", (e) => { e.stopPropagation(); lightboxNav(1); });
    document.addEventListener("keydown", (e) => {
      if (!lightbox.classList.contains("is-open")) return;
      if (e.key === "Escape") closeLightbox();
      if (e.key === "ArrowLeft") lightboxNav(-1);
      if (e.key === "ArrowRight") lightboxNav(1);
    });

    // Main image click opens lightbox
    galleryMain.addEventListener("click", () => {
      if (allImages.length > 0) openLightbox(currentIndex);
    });

    fetch(`/api/projects/${slug}`)
      .then(r => r.json())
      .then(data => {
        if (!data.ok || !data.project) {
          projTitle.textContent = "Proyecto no encontrado";
          projContent.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);">Este proyecto no existe o no esta disponible.</div>';
          return;
        }
        const p = data.project;
        document.title = `Cerberus Dev | ${p.title}`;
        projTitle.textContent = p.title;

        const metaParts = [];
        if (p.tag) metaParts.push('<span style="color:var(--orange);">' + esc(p.tag) + '</span>');
        if (p.date) metaParts.push(fmtDate(p.date));
        projMeta.innerHTML = metaParts.join(' &bull; ');

        // Build images array (main + gallery)
        allImages = [];
        if (p.image_url) allImages.push(p.image_url);
        if (p.images && p.images.length > 0) {
          p.images.forEach(img => {
            if (!allImages.includes(img)) allImages.push(img);
          });
        }

        // Show gallery if there are images
        if (allImages.length > 0) {
          projGallery.style.display = "";
          galleryMainImg.src = allImages[0];
          galleryCounter.textContent = `1 / ${allImages.length}`;

          // Build thumbnails
          if (allImages.length > 1) {
            galleryThumbs.innerHTML = allImages.map((img, i) => `
              <div class="proj-gallery-thumb ${i === 0 ? 'is-active' : ''}" data-index="${i}">
                <img src="${esc(img)}" alt="Imagen ${i + 1}">
              </div>
            `).join("");

            galleryThumbs.querySelectorAll(".proj-gallery-thumb").forEach(thumb => {
              thumb.addEventListener("click", () => {
                updateGallery(Number(thumb.dataset.index));
              });
            });
          } else {
            galleryCounter.style.display = "none";
          }
        }

        // Content (without main image since we have the gallery now)
        projContent.innerHTML = `
          ${p.description ? '<p style="font-size:17px;color:var(--text-body);line-height:1.8;margin-bottom:24px;">' + esc(p.description) + '</p>' : ''}
          <div class="blog-post-content">${p.content || ''}</div>
        `;

        // Show technologies
        if (p.technologies && p.technologies.length > 0) {
          projTechsSection.style.display = "";
          projTechsGrid.innerHTML = p.technologies.map(t => `
            <div class="tech">
              <img src="${esc(t.tech_icon)}" alt="${esc(t.tech_name)}">
              <span>${esc(t.tech_name)}</span>
            </div>
          `).join("");
        }
      })
      .catch(() => {
        projTitle.textContent = "Error al cargar";
      });
  })();
  </script>
</body>
</html>
